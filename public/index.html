<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ù§Ô∏è Like Duel - Qayta Uchrashuv & Gender Filtr</title>
    
    <!-- Socket.io CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Telegram Web App -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Confetti animatsiya -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==================== YANGI MODALLAR ==================== */
        .gender-modal, .rematch-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .gender-modal.active, .rematch-modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            color: #333;
        }
        
        .gender-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        
        .gender-option-btn {
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .gender-option-btn:active {
            transform: scale(0.98);
        }
        
        /* Gender tugmalari ranglari */
        .gender-male {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .gender-female {
            background: linear-gradient(135deg, #e84393, #fd79a8);
            color: white;
        }
        
        .gender-all {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        
        /* Qayta uchrashuv indikatorlari */
        .met-again-indicator {
            background: linear-gradient(135deg, #ffeaa7, #fab1a0);
            padding: 10px 15px;
            border-radius: 15px;
            margin: 10px 0;
            color: #333;
            font-weight: 600;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        /* Gender display */
        .gender-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin-left: 8px;
            font-weight: bold;
        }
        
        .gender-male-badge {
            background: #3498db;
            color: white;
        }
        
        .gender-female-badge {
            background: #e84393;
            color: white;
        }
        
        .gender-all-badge {
            background: #9b59b6;
            color: white;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- ... (oldingi kodning barcha HTML qismi) ... -->
    </div>
    
    <!-- ==================== YANGI MODALLAR ==================== -->
    
    <!-- GENDER TANLASH MODALI -->
    <div class="gender-modal" id="genderModal">
        <div class="modal-content">
            <div style="font-size: 3rem; margin-bottom: 15px;">üë§</div>
            <h2 style="margin-bottom: 10px;">Jinsni Tanlang</h2>
            <p style="margin-bottom: 20px; opacity: 0.7;">
                Bu sizning duel qilish sozlamangiz. Keyinchalik profil orqali o'zgartirishingiz mumkin.
            </p>
            
            <div class="gender-options">
                <button class="gender-option-btn gender-male" id="selectMaleBtn">
                    <i class="fas fa-mars"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: bold;">Erkak</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Faqat ayollar bilan duel</div>
                    </div>
                </button>
                
                <button class="gender-option-btn gender-female" id="selectFemaleBtn">
                    <i class="fas fa-venus"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: bold;">Ayol</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Faqat erkaklar bilan duel</div>
                    </div>
                </button>
                
                <button class="gender-option-btn gender-all" id="selectAllBtn">
                    <i class="fas fa-users"></i>
                    <div style="text-align: left; flex: 1;">
                        <div style="font-weight: bold;">Hammasi</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">Har qanday jins bilan duel</div>
                    </div>
                </button>
            </div>
            
            <p style="font-size: 0.8rem; margin-top: 20px; opacity: 0.5;">
                * Sozlamalarni keyinchalik o'zgartirishingiz mumkin
            </p>
        </div>
    </div>
    
    <!-- QAYTA DUEL SO'ROVI MODALI -->
    <div class="rematch-modal" id="rematchModal">
        <div class="modal-content">
            <div style="font-size: 3rem; margin-bottom: 15px;">üîÑ</div>
            <h2 style="margin-bottom: 10px;">Qayta Duel?</h2>
            <p style="margin-bottom: 20px; opacity: 0.7;" id="rematchMessage">
                <span id="rematchOpponentName">Raqib</span> bilan yana duel o'ynashni xohlaysizmi?
            </p>
            
            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button class="match-option-btn" id="declineRematchBtn" style="background: #ff6b6b; flex: 1;">
                    <i class="fas fa-times"></i> Yo'q
                </button>
                <button class="match-option-btn" id="acceptRematchBtn" style="background: #2ecc71; flex: 1;">
                    <i class="fas fa-check"></i> Ha
                </button>
            </div>
            
            <div style="margin-top: 20px; font-size: 0.8rem; opacity: 0.5;">
                Qayta duelda bonus +20 coin va +15 XP olasiz
            </div>
        </div>
    </div>
    
    <script>
        // ==================== YANGI O'ZGARUVCHILAR ====================
        let currentGender = 'not_specified';
        let hasSelectedGender = false;
        let lastOpponent = null;
        
        // ==================== GENDER MODALI ====================
        const genderModal = document.getElementById('genderModal');
        const selectMaleBtn = document.getElementById('selectMaleBtn');
        const selectFemaleBtn = document.getElementById('selectFemaleBtn');
        const selectAllBtn = document.getElementById('selectAllBtn');
        
        function showGenderModal() {
            genderModal.classList.add('active');
        }
        
        function hideGenderModal() {
            genderModal.classList.remove('active');
        }
        
        function selectGender(gender) {
            if (gameState.socket) {
                gameState.socket.emit('select_gender', { gender: gender });
                currentGender = gender;
                hasSelectedGender = true;
                hideGenderModal();
                
                // UI ni yangilash
                showNotification('‚úÖ Jins Tanlandi', 
                    gender === 'male' ? 'Endi faqat ayollar bilan duel o\'ynaysiz' :
                    gender === 'female' ? 'Endi faqat erkaklar bilan duel o\'ynaysiz' :
                    'Endi hamma bilan duel o\'ynaysiz');
            }
        }
        
        selectMaleBtn.addEventListener('click', () => selectGender('male'));
        selectFemaleBtn.addEventListener('click', () => selectGender('female'));
        selectAllBtn.addEventListener('click', () => selectGender('not_specified'));
        
        // ==================== QAYTA DUEL MODALI ====================
        const rematchModal = document.getElementById('rematchModal');
        const rematchOpponentName = document.getElementById('rematchOpponentName');
        const rematchMessage = document.getElementById('rematchMessage');
        const acceptRematchBtn = document.getElementById('acceptRematchBtn');
        const declineRematchBtn = document.getElementById('declineRematchBtn');
        
        function showRematchModal(opponentName, opponentId) {
            rematchOpponentName.textContent = opponentName;
            lastOpponent = opponentId;
            rematchModal.classList.add('active');
        }
        
        function hideRematchModal() {
            rematchModal.classList.remove('active');
        }
        
        acceptRematchBtn.addEventListener('click', () => {
            if (gameState.socket && lastOpponent) {
                // Qayta duel so'rovini yuborish
                gameState.socket.emit('request_rematch', { opponentId: lastOpponent });
                showNotification('üîÑ So\'rov Yuborildi', 'Qayta duel so\'rovi yuborildi');
            }
            hideRematchModal();
        });
        
        declineRematchBtn.addEventListener('click', hideRematchModal);
        
        // ==================== SOCKET.IO EVENTLARI ====================
        
        // Gender tanlash modalini ko'rsatish
        gameState.socket?.on('show_gender_selection', () => {
            console.log('üë§ Gender tanlash modali ko\'rsatiladi');
            showGenderModal();
        });
        
        // Gender tanlanganini bildirish
        gameState.socket?.on('gender_selected', (data) => {
            console.log(`‚úÖ Gender tanlandi: ${data.gender}`);
            currentGender = data.gender;
            hasSelectedGender = true;
            
            // Profil UI ni yangilash
            const genderBadge = document.createElement('span');
            genderBadge.className = `gender-badge gender-${data.gender}-badge`;
            genderBadge.textContent = 
                data.gender === 'male' ? '‚ôÇ Erkak' :
                data.gender === 'female' ? '‚ôÄ Ayol' : 'üë• Hammasi';
            
            // Profil ekraniga gender qo'shish
            const profileName = document.getElementById('profileName');
            profileName.appendChild(genderBadge.cloneNode(true));
            
            const myName = document.getElementById('myName');
            myName.appendChild(genderBadge.cloneNode(true));
            
            // Raqibning genderini ko'rsatish
            gameState.socket?.on('duel_started', (data) => {
                if (data.opponent.gender) {
                    const opponentName = document.getElementById('opponentName');
                    const opponentGenderBadge = document.createElement('span');
                    opponentGenderBadge.className = `gender-badge gender-${data.opponent.gender}-badge`;
                    opponentGenderBadge.textContent = 
                        data.opponent.gender === 'male' ? '‚ôÇ' :
                        data.opponent.gender === 'female' ? '‚ôÄ' : 'üë•';
                    opponentName.appendChild(opponentGenderBadge);
                }
            });
        });
        
        // QAYTA UCHRASHUV: Duel boshlanganda
        gameState.socket?.on('duel_started', (data) => {
            console.log('üéÆ Duel boshladi');
            
            // Qayta uchrashuv bo'lsa
            if (data.hasMetBefore) {
                console.log(`üîÑ QAYTA UCHRASHUV: Avvalgi natija: ${data.previousResult}`);
                
                // Maxsus indikator qo'shish
                const metAgainIndicator = document.createElement('div');
                metAgainIndicator.className = 'met-again-indicator';
                
                let message = '';
                let icon = 'üîÑ';
                
                switch(data.previousResult) {
                    case 'match':
                        message = 'Avval MATCH qilgansiz!';
                        icon = 'üíñ';
                        break;
                    case 'liked_only':
                        message = 'Avval siz yoqtirgansiz';
                        icon = '‚ù§Ô∏è';
                        break;
                    case 'was_liked':
                        message = 'Avval u sizni yoqtirgan';
                        icon = '‚ù§Ô∏è';
                        break;
                    case 'no_match':
                        message = 'Avval ikkalangiz ham yoqtirmagansiz';
                        icon = '‚úñÔ∏è';
                        break;
                    default:
                        message = 'Avval uchrashgansiz';
                }
                
                metAgainIndicator.innerHTML = `${icon} ${message}`;
                
                // Duel ekraniga qo'shish
                const duelScreen = document.getElementById('duelScreen');
                duelScreen.insertBefore(metAgainIndicator, duelScreen.firstChild);
                
                // Avvalgi ovozlarni ko'rsatish
                if (data.previousVotes) {
                    const votesIndicator = document.createElement('div');
                    votesIndicator.className = 'previous-match-indicator';
                    votesIndicator.style.background = 'rgba(255,255,255,0.1)';
                    votesIndicator.style.padding = '10px';
                    votesIndicator.style.borderRadius = '10px';
                    votesIndicator.style.margin = '10px 0';
                    votesIndicator.style.fontSize = '0.9rem';
                    
                    votesIndicator.innerHTML = `
                        <div>üìä Avvalgi ovozlar:</div>
                        <div>Siz: ${getVoteEmoji(data.previousVotes[gameState.playerData?.id])}</div>
                        <div>U: ${getVoteEmoji(data.previousVotes[data.opponent.id])}</div>
                    `;
                    
                    duelScreen.insertBefore(votesIndicator, duelScreen.children[1]);
                }
            }
        });
        
        function getVoteEmoji(vote) {
            switch(vote) {
                case 'like': return '‚ù§Ô∏è';
                case 'super_like': return 'üíñ';
                case 'skip': return '‚úñÔ∏è';
                default: return '‚ùì';
            }
        }
        
        // QAYTA UCHRASHUV: Match bo'lganda
        gameState.socket?.on('match', (data) => {
            // Qayta uchrashuv bo'lsa
            if (data.isRematch) {
                console.log('üéâ QAYTA UCHRASHUV MATCH!');
                
                // Maxsus xabarni o'rnatish
                const matchText = document.getElementById('matchText');
                if (matchText) {
                    matchText.innerHTML = `
                        <div style="font-size: 1.5rem; margin-bottom: 10px;">üéâ QAYTA UCHRASHUV!</div>
                        <div>${data.matchMessage}</div>
                    `;
                }
                
                // Bonusni ko'rsatish
                const rewards = document.getElementById('matchRewards');
                if (rewards) {
                    rewards.innerHTML += `
                        <div style="margin-top: 10px; padding: 5px 10px; background: rgba(255, 215, 0, 0.3); border-radius: 10px;">
                            <i class="fas fa-gift"></i> Qayta uchrashuv bonus: +20 coin, +15 XP
                        </div>
                    `;
                }
                
                // Qayta duel tugmasini qo'shish
                const matchOptions = document.getElementById('matchOptions');
                if (matchOptions) {
                    const rematchBtn = document.createElement('button');
                    rematchBtn.className = 'match-option-btn';
                    rematchBtn.innerHTML = 'üîÑ Qayta duel';
                    rematchBtn.style.background = '#9b59b6';
                    rematchBtn.addEventListener('click', () => {
                        if (gameState.socket && data.partner.id) {
                            gameState.socket.emit('request_rematch', { opponentId: data.partner.id });
                            showNotification('üîÑ So\'rov Yuborildi', 'Qayta duel so\'rovi yuborildi');
                        }
                    });
                    matchOptions.appendChild(rematchBtn);
                }
            }
        });
        
        // QAYTA DUEL SO'ROVI
        gameState.socket?.on('rematch_request', (data) => {
            showRematchModal(data.opponentName, data.opponentId);
        });
        
        gameState.socket?.on('rematch_accepted', (data) => {
            showNotification('‚úÖ Qayta Duel', `${data.opponentName} qayta duelni qabul qildi!`);
        });
        
        gameState.socket?.on('rematch_declined', (data) => {
            showNotification('‚ùå Qayta Duel', `${data.opponentName} qayta duelni rad etdi`);
        });
        
        // ==================== PROFILNI YANGILASH ====================
        
        // Profilni tahrirlash modalida gender tanlash
        document.addEventListener('DOMContentLoaded', function() {
            const editGender = document.getElementById('editGender');
            if (editGender) {
                editGender.addEventListener('change', function() {
                    currentGender = this.value;
                    hasSelectedGender = this.value !== 'not_specified';
                });
            }
            
            // Save profile tugmasi
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            if (saveProfileBtn) {
                saveProfileBtn.addEventListener('click', function() {
                    if (gameState.socket) {
                        const newGender = editGender ? editGender.value : 'not_specified';
                        gameState.socket.emit('update_profile', {
                            bio: document.getElementById('editBio').value,
                            gender: newGender
                        });
                    }
                });
            }
        });
        
        // Gender o'zgartirilganda
        gameState.socket?.on('profile_updated', (data) => {
            if (data.gender) {
                currentGender = data.gender;
                hasSelectedGender = data.gender !== 'not_specified';
                
                // UI ni yangilash
                const genderBadges = document.querySelectorAll('.gender-badge');
                genderBadges.forEach(badge => badge.remove());
                
                const newBadge = document.createElement('span');
                newBadge.className = `gender-badge gender-${data.gender}-badge`;
                newBadge.textContent = 
                    data.gender === 'male' ? '‚ôÇ Erkak' :
                    data.gender === 'female' ? '‚ôÄ Ayol' : 'üë• Hammasi';
                
                const profileName = document.getElementById('profileName');
                const myName = document.getElementById('myName');
                
                if (profileName) profileName.appendChild(newBadge.cloneNode(true));
                if (myName) myName.appendChild(newBadge.cloneNode(true));
                
                showNotification('‚úÖ Profil Yangilandi', `Gender: ${newBadge.textContent}`);
            }
        });
        
        // ==================== AVTOMATIK GENDER MODAL ====================
        
        // O'yinchi birinchi marta kirganda gender tanlash
        function checkGenderSelection() {
            if (!hasSelectedGender) {
                // 3 soniyadan keyin modalni ko'rsatish
                setTimeout(() => {
                    if (!hasSelectedGender && gameState.isConnected) {
                        showGenderModal();
                    }
                }, 3000);
            }
        }
        
        // Socket ulanganda tekshirish
        gameState.socket?.on('connect', () => {
            setTimeout(checkGenderSelection, 1000);
        });
    </script>
</body>
</html>