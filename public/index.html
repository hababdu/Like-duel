<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Like Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; background: linear-gradient(135deg, #ff6b6b, #4ecdc4); color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .container { width: 100%; max-width: 400px; text-align: center; }
    h1 { font-size: 36px; margin-bottom: 20px; }

    /* MODAL */
    #profileModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; }
    .modal-content { background: white; color: #333; padding: 30px; border-radius: 25px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
    .modal-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 5px solid #ff6b6b; margin-bottom: 20px; }
    .modal-name { font-size: 28px; font-weight: bold; margin: 10px 0; }
    .modal-info { font-size: 18px; margin: 8px 0; color: #555; }
    .modal-likes { font-size: 20px; color: #ff3366; margin: 15px 0; }
    #startBtn { background: #ff3366; color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 20px; cursor: pointer; margin-top: 20px; }

    /* DUEL PANEL */
    .opponent { margin: 30px 0; }
    .avatar { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 8px solid rgba(255,255,255,0.3); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .name { font-size: 28px; margin: 15px 0 10px; font-weight: bold; }
    .timer { font-size: 72px; font-weight: bold; margin: 40px 0; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
    .buttons { display: flex; justify-content: center; gap: 50px; margin-top: 30px; }
    button { width: 120px; height: 120px; border-radius: 50%; border: none; font-size: 70px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: transform 0.2s; }
    button:active { transform: scale(0.9); }
    .like { background: #ff3366; }
    .nolike { background: #333; }
    .status { margin-top: 30px; font-size: 20px; line-height: 1.6; }
    .hidden { display: none; }
    .match-box { animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  </style>
</head>
<body>
  <div class="container">
    <h1>Like Duel</h1>
    <div class="status" id="status">Juft topilmoqda...</div>
  </div>

  <!-- PROFILE MODAL -->
  <div id="profileModal">
    <div class="modal-content">
      <img id="myAvatar" class="modal-avatar" src="" alt="Siz">
      <div id="myName" class="modal-name"></div>
      <div id="myUsername" class="modal-info"></div>
      <div id="myGender" class="modal-info"></div>
      <div id="myLikes" class="modal-likes">Yoqtirganlar: 0</div>
      <button id="startBtn">Boshlash</button>
    </div>
  </div>

  <!-- DUEL PANEL -->
  <div class="opponent hidden" id="duelPanel">
    <img id="oppAvatar" class="avatar" src="" alt="Raqib">
    <div id="oppName" class="name">Juft topilmoqda...</div>
  </div>

  <div class="timer hidden" id="timer">15</div>

  <div class="buttons hidden" id="voteButtons">
    <button class="nolike" id="noBtn">✖</button>
    <button class="like" id="yesBtn">❤️</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const user = Telegram.WebApp.initDataUnsafe.user || { id: 999, first_name: "Test", username: "testuser" };
    const socket = io();

    let currentOpponent = null;
    let timeLeft = 15;
    let timerInterval = null;
    let likedCount = 0;

    // Modalni to‘ldirish
    document.getElementById('myAvatar').src = user.photo_url || `https://t.me/i/userpic/320/${user.id}.jpg`;
    document.getElementById('myName').textContent = user.first_name + (user.last_name ? ' ' + user.last_name : '');
    document.getElementById('myUsername').textContent = '@' + (user.username || 'username_yoq');
    document.getElementById('myGender').textContent = 'Jins: Belgilanmagan'; // keyinroq qo‘shamiz
    document.getElementById('myLikes').textContent = `Yoqtirganlar: ${likedCount}`;

    // Boshlash tugmasi
    document.getElementById('startBtn').onclick = () => {
      document.getElementById('profileModal').style.display = 'none';
      socket.emit('auth', {
        telegramId: user.id,
        username: user.username || user.first_name,
        photo: user.photo_url
      });
    };

    socket.on('pair_started', (data) => {
      currentOpponent = data.opponent;

      document.getElementById('oppAvatar').src = currentOpponent.photo || `https://t.me/i/userpic/320/${currentOpponent.id}.jpg`;
      document.getElementById('oppName').textContent = currentOpponent.name;

      document.getElementById('duelPanel').classList.remove('hidden');
      document.getElementById('voteButtons').classList.remove('hidden');
      document.getElementById('timer').classList.remove('hidden');
      document.getElementById('status').textContent = '';

      startTimer();
    });

    function startTimer() {
      timeLeft = 15;
      document.getElementById('timer').textContent = timeLeft;
      timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          vote('skip');
        }
      }, 1000);
    }

    document.getElementById('yesBtn').onclick = () => vote('like');
    document.getElementById('noBtn').onclick = () => vote('nolike');

    function vote(choice) {
      clearInterval(timerInterval);
      socket.emit('vote', { choice });

      document.getElementById('voteButtons').classList.add('hidden');
      document.getElementById('timer').textContent = choice === 'like' ? '❤️' : '✖';
      document.getElementById('status').textContent = 'Kutilyapti...';
    }

    socket.on('match', (data) => {
      confetti({ particleCount: 300, spread: 100, origin: { y: 0.6 } });
      Telegram.WebApp.HapticFeedback.notificationOccurred('success');

      document.getElementById('status').innerHTML = `
        <div class="match-box">
          <h1 style="font-size:60px">MATCH!</h1>
          <p style="font-size:24px">${data.partner.name} bilan suhbatlashish</p>
          <button onclick="Telegram.WebApp.openTelegramLink('https://t.me/${data.partner.name.replace('@','')}')" 
                  style="margin-top:20px;padding:15px 30px;font-size:20px;border-radius:30px;background:#ff3366;border:none;color:white;">
            Chatga o'tish
          </button>
        </div>
      `;
    });

    socket.on('liked_only', () => {
      likedCount++;
      document.getElementById('myLikes').textContent = `Yoqtirganlar: ${likedCount}`;
      Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
      document.getElementById('status').textContent = "Yoqtirdingiz, lekin u yoqtirmadi";
      setTimeout(resetForNext, 2000);
    });

    socket.on('no_match', () => {
      Telegram.WebApp.HapticFeedback.notificationOccurred('error');
      document.getElementById('status').textContent = "Keyingi juft izlanmoqda...";
      setTimeout(resetForNext, 2000);
    });

    function resetForNext() {
      document.getElementById('duelPanel').classList.add('hidden');
      document.getElementById('voteButtons').classList.add('hidden');
      document.getElementById('timer').classList.add('hidden');
      document.getElementById('timer').textContent = "15";
      document.getElementById('status').textContent = "Juft topilmoqda...";
    }
  </script>
</body>
</html>