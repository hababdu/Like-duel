<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Like Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* Telegram Web App standartlariga mos stil */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, system-ui, "Segoe UI", Roboto, sans-serif;
      background: var(--tg-theme-bg-color, linear-gradient(135deg, #ff6b6b, #4ecdc4));
      color: var(--tg-theme-text-color, #ffffff);
      min-height: 100vh;
      padding: 0;
      margin: 0;
    }
    
    /* Telegram xabarlari uchun joy qoldirish */
    body:before {
      content: '';
      display: block;
      height: calc(16px + var(--tg-viewport-stable-height, 0px));
    }
    
    .container {
      width: 100%;
      max-width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
    
    h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 32px;
      text-align: center;
      color: var(--tg-theme-text-color, #ffffff);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    /* PROFILE MODAL */
    #profileModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--tg-theme-secondary-bg-color, rgba(0, 0, 0, 0.9));
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal-content {
      background: var(--tg-theme-bg-color, #ffffff);
      color: var(--tg-theme-text-color, #000000);
      padding: 32px 24px;
      border-radius: 24px;
      width: 100%;
      max-width: 320px;
      text-align: center;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.25);
    }
    
    .modal-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--tg-theme-button-color, #ff6b6b);
      margin-bottom: 24px;
    }
    
    .modal-name {
      font-size: 24px;
      font-weight: 700;
      margin: 0 0 12px 0;
      line-height: 1.2;
    }
    
    .modal-info {
      font-size: 16px;
      margin: 8px 0;
      color: var(--tg-theme-hint-color, #6c757d);
      line-height: 1.4;
    }
    
    .modal-likes {
      font-size: 20px;
      font-weight: 600;
      color: var(--tg-theme-button-color, #ff3366);
      margin: 20px 0;
      line-height: 1.3;
    }
    
    #startBtn {
      background: var(--tg-theme-button-color, #ff3366);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      padding: 16px 32px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      width: 100%;
      min-height: 56px;
      transition: transform 0.1s, opacity 0.1s;
    }
    
    #startBtn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    
    /* DUEL PANEL */
    .duel-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      width: 100%;
      padding: 20px 0;
    }
    
    .opponent {
      margin: 32px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .avatar {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      object-fit: cover;
      border: 6px solid var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.2));
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      margin-bottom: 24px;
    }
    
    .name {
      font-size: 24px;
      font-weight: 600;
      margin: 16px 0;
      text-align: center;
      line-height: 1.3;
      padding: 0 20px;
    }
    
    .timer {
      font-size: 64px;
      font-weight: 800;
      margin: 32px 0;
      text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      line-height: 1;
    }
    
    /* TUGMALAR (44px dan katta) */
    .buttons {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin: 32px 0;
      width: 100%;
      max-width: 320px;
    }
    
    button.vote-btn {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      font-size: 48px;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      transition: transform 0.1s, opacity 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100px;
    }
    
    button.vote-btn:active {
      transform: scale(0.95);
      opacity: 0.9;
    }
    
    .nolike {
      background: var(--tg-theme-secondary-bg-color, #2c3e50);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
    
    .like {
      background: var(--tg-theme-button-color, #ff3366);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
    
    /* STATUS XABARLARI */
    .status {
      margin-top: 32px;
      font-size: 18px;
      line-height: 1.5;
      text-align: center;
      padding: 0 20px;
      min-height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* MATCH ANIMATSIYA */
    .match-box {
      animation: pulse 1s infinite;
      text-align: center;
      padding: 24px;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .match-btn {
      background: var(--tg-theme-button-color, #ff3366);
      color: var(--tg-theme-button-text-color, #ffffff);
      border: none;
      padding: 18px 36px;
      border-radius: 20px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 24px;
      min-height: 56px;
      transition: transform 0.1s, opacity 0.1s;
      width: 100%;
      max-width: 280px;
    }
    
    .match-btn:active {
      transform: scale(0.98);
      opacity: 0.9;
    }
    
    /* MASOFALAR (20-40px) */
    .spacing-sm { margin: 20px 0; }
    .spacing-md { margin: 30px 0; }
    .spacing-lg { margin: 40px 0; }
    
    /* Responsive */
    @media (max-width: 480px) {
      .avatar {
        width: 160px;
        height: 160px;
      }
      
      button.vote-btn {
        width: 90px;
        height: 90px;
        font-size: 44px;
      }
      
      .timer {
        font-size: 56px;
      }
    }
    
    @media (max-height: 700px) {
      .avatar {
        width: 140px;
        height: 140px;
      }
      
      h1 {
        font-size: 28px;
        margin-bottom: 24px;
      }
      
      .timer {
        font-size: 48px;
        margin: 24px 0;
      }
    }
  </style>
</head>
<body>
  <!-- PROFILE MODAL -->
  <div id="profileModal">
    <div class="modal-content">
      <img id="myAvatar" class="modal-avatar" src="" alt="Siz" crossorigin="anonymous">
      <div id="myName" class="modal-name">Yuklanmoqda...</div>
      <div id="myUsername" class="modal-info">@username</div>
      <div id="myGender" class="modal-info">Jins: Belgilanmagan</div>
      <div id="myLikes" class="modal-likes">Yoqtirganlar: <span id="likesCount">0</span></div>
      <button id="startBtn">O'yinni boshlash</button>
    </div>
  </div>

  <!-- ASOSIY KONTEYNER -->
  <div class="container">
    <h1>‚ù§Ô∏è Like Duel</h1>
    
    <div class="duel-container">
      <!-- DUEL PANEL -->
      <div class="opponent hidden" id="duelPanel">
        <img id="oppAvatar" class="avatar" src="" alt="Raqib" crossorigin="anonymous">
        <div id="oppName" class="name">Juft topilmoqda...</div>
      </div>
      
      <!-- TIMER -->
      <div class="timer hidden" id="timer">15</div>
      
      <!-- TUGMALAR -->
      <div class="buttons hidden" id="voteButtons">
        <button class="vote-btn nolike" id="noBtn" aria-label="Yoqtirmadi">‚úñ</button>
        <button class="vote-btn like" id="yesBtn" aria-label="Yoqtirdi">‚ù§Ô∏è</button>
      </div>
      
      <!-- STATUS -->
      <div class="status" id="status">Juft topilmoqda...</div>
      
      <!-- MATCH MESSAGE (dynamic) -->
      <div id="matchMessage" class="hidden"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Telegram Web App ishga tushirish
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    
    // Telegram foydalanuvchi ma'lumotlari
    const tgUser = Telegram.WebApp.initDataUnsafe.user || {
      id: Math.floor(Math.random() * 10000),
      first_name: "Mehmon",
      username: "guest"
    };
    
    // App holatlari
    let likedCount = 0;
    let currentOpponent = null;
    let timeLeft = 15;
    let timerInterval = null;
    let socket = null;
    
    // DOM elementlari
    const elements = {
      profileModal: document.getElementById('profileModal'),
      duelPanel: document.getElementById('duelPanel'),
      timer: document.getElementById('timer'),
      voteButtons: document.getElementById('voteButtons'),
      status: document.getElementById('status'),
      matchMessage: document.getElementById('matchMessage'),
      likesCount: document.getElementById('likesCount'),
      myAvatar: document.getElementById('myAvatar'),
      myName: document.getElementById('myName'),
      myUsername: document.getElementById('myUsername'),
      myGender: document.getElementById('myGender'),
      startBtn: document.getElementById('startBtn'),
      oppAvatar: document.getElementById('oppAvatar'),
      oppName: document.getElementById('oppName'),
      noBtn: document.getElementById('noBtn'),
      yesBtn: document.getElementById('yesBtn')
    };
    
    // Foydalanuvchi ma'lumotlarini sozlash
    function initializeUserProfile() {
      const userPhoto = tgUser.photo_url || `https://t.me/i/userpic/320/${tgUser.id}.jpg`;
      const userFullName = (tgUser.first_name || 'Foydalanuvchi') + (tgUser.last_name ? ' ' + tgUser.last_name : '');
      const userUsername = tgUser.username ? '@' + tgUser.username : 'Username yo‚Äòq';
      
      elements.myAvatar.src = userPhoto;
      elements.myName.textContent = userFullName;
      elements.myUsername.textContent = userUsername;
      elements.likesCount.textContent = likedCount;
      
      // Jinsni aniqlash (agar mavjud bo'lsa)
      if (tgUser.gender) {
        elements.myGender.textContent = `Jins: ${tgUser.gender === 'male' ? 'Erkak' : 'Ayol'}`;
      }
    }
    
    // Socket.io ulanishi
    function connectSocket() {
      socket = io();
      
      socket.on('connect', () => {
        console.log('Socket connected');
        socket.emit('auth', {
          telegramId: tgUser.id,
          username: tgUser.username || tgUser.first_name,
          photo: tgUser.photo_url,
          name: tgUser.first_name + (tgUser.last_name ? ' ' + tgUser.last_name : '')
        });
      });
      
      socket.on('pair_started', handlePairStarted);
      socket.on('match', handleMatch);
      socket.on('liked_only', handleLikedOnly);
      socket.on('no_match', handleNoMatch);
      socket.on('disconnect', handleDisconnect);
    }
    
    // Juft topilganda
    function handlePairStarted(data) {
      currentOpponent = data.opponent;
      
      elements.oppAvatar.src = currentOpponent.photo || `https://t.me/i/userpic/320/${currentOpponent.id}.jpg`;
      elements.oppName.textContent = currentOpponent.name || 'Foydalanuvchi';
      
      // UI ni ko'rsatish
      elements.duelPanel.classList.remove('hidden');
      elements.voteButtons.classList.remove('hidden');
      elements.timer.classList.remove('hidden');
      elements.status.textContent = '';
      elements.matchMessage.classList.add('hidden');
      
      startTimer();
      Telegram.WebApp.HapticFeedback.impactOccurred('light');
    }
    
    // Taymerni boshlash
    function startTimer() {
      clearInterval(timerInterval);
      timeLeft = 15;
      elements.timer.textContent = timeLeft;
      
      timerInterval = setInterval(() => {
        timeLeft--;
        elements.timer.textContent = timeLeft;
        
        if (timeLeft <= 5) {
          elements.timer.style.color = '#ff4444';
        }
        
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          vote('skip');
        }
      }, 1000);
    }
    
    // Ovoz berish
    function vote(choice) {
      clearInterval(timerInterval);
      
      if (socket && socket.connected) {
        socket.emit('vote', { choice });
      }
      
      // UI yangilash
      elements.voteButtons.classList.add('hidden');
      elements.timer.textContent = choice === 'like' ? '‚ù§Ô∏è' : '‚úñ';
      elements.status.textContent = 'Kutilyapti...';
      elements.timer.style.color = '';
      
      // Haptic feedback
      if (choice === 'like') {
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      } else {
        Telegram.WebApp.HapticFeedback.impactOccurred('light');
      }
    }
    
    // Match bo'lganda
    function handleMatch(data) {
      // Confetti animatsiya
      confetti({
        particleCount: 200,
        spread: 100,
        origin: { y: 0.6 }
      });
      
      // Haptic feedback
      Telegram.WebApp.HapticFeedback.notificationOccurred('success');
      
      // Match xabarini ko'rsatish
      elements.duelPanel.classList.add('hidden');
      elements.timer.classList.add('hidden');
      elements.status.classList.add('hidden');
      
      elements.matchMessage.innerHTML = `
        <div class="match-box">
          <h1 style="font-size: 48px; margin-bottom: 20px;">üéâ MATCH!</h1>
          <p style="font-size: 20px; margin-bottom: 32px;">${data.partner.name} bilan suhbatlashish</p>
          <button class="match-btn" onclick="openChat('${data.partner.username || data.partner.name}')">
            üí¨ Chatga o'tish
          </button>
        </div>
      `;
      
      elements.matchMessage.classList.remove('hidden');
    }
    
    // Faqat bir tomon yoqtirganda
    function handleLikedOnly() {
      likedCount++;
      elements.likesCount.textContent = likedCount;
      
      Telegram.WebApp.HapticFeedback.notificationOccurred('warning');
      elements.status.textContent = "Siz yoqtirdingiz, lekin juftingiz yoqtirmadi";
      
      setTimeout(resetForNext, 2000);
    }
    
    // Match bo'lmaganda
    function handleNoMatch() {
      Telegram.WebApp.HapticFeedback.notificationOccurred('error');
      elements.status.textContent = "Keyingi juft izlanmoqda...";
      
      setTimeout(resetForNext, 2000);
    }
    
    // Socket uzilganda
    function handleDisconnect() {
      elements.status.textContent = "Ulanish uzildi. Qayta ulanmoqda...";
      setTimeout(connectSocket, 3000);
    }
    
    // Keyingi juftga tayyorlash
    function resetForNext() {
      elements.duelPanel.classList.add('hidden');
      elements.voteButtons.classList.add('hidden');
      elements.timer.classList.add('hidden');
      elements.matchMessage.classList.add('hidden');
      
      elements.status.classList.remove('hidden');
      elements.status.textContent = "Yangi juft topilmoqda...";
      elements.timer.textContent = "15";
      elements.timer.style.color = '';
    }
    
    // Chatga o'tish
    function openChat(username) {
      const cleanUsername = username.replace('@', '');
      Telegram.WebApp.openTelegramLink(`https://t.me/${cleanUsername}`);
    }
    
    // Dasturni ishga tushirish
    function initializeApp() {
      // Profilni sozlash
      initializeUserProfile();
      
      // Tugmalarga event listener'lar
      elements.startBtn.addEventListener('click', () => {
        elements.profileModal.style.display = 'none';
        connectSocket();
      });
      
      elements.yesBtn.addEventListener('click', () => vote('like'));
      elements.noBtn.addEventListener('click', () => vote('nolike'));
      
      // Touch event'lar
      elements.yesBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        elements.yesBtn.style.transform = 'scale(0.95)';
      });
      
      elements.yesBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        elements.yesBtn.style.transform = '';
        vote('like');
      });
      
      elements.noBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        elements.noBtn.style.transform = 'scale(0.95)';
      });
      
      elements.noBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        elements.noBtn.style.transform = '';
        vote('nolike');
      });
    }
    
    // App ishga tushganda
    document.addEventListener('DOMContentLoaded', initializeApp);
    
    // Back button handler
    Telegram.WebApp.BackButton.onClick(() => {
      if (!elements.profileModal.style.display || elements.profileModal.style.display === 'none') {
        elements.profileModal.style.display = 'flex';
        resetForNext();
        if (socket) socket.disconnect();
      }
    });
    
    Telegram.WebApp.BackButton.show();
  </script>
</body>
</html>