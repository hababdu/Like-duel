<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Like Duel</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { margin:0; font-family: system-ui; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; min-height:100vh; }
    .container { padding: 20px; text-align:center; padding-top: 15vh; }
    h1 { font-size: 28px; margin-bottom: 40px; }
    button { 
      background: rgba(255,255,255,0.2); color: white; border: none; 
      padding: 20px 40px; margin: 15px; border-radius: 20px; 
      font-size: 22px; width: 80%; backdrop-filter: blur(10px);
    }
    button:active { background: rgba(255,255,255,0.4); }
    #status { margin-top: 30px; font-size: 18px; line-height: 1.6; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Like Duel</h1>
    <button id="btn">Kutilyapman...</button>
    <div id="status">Telegram maʼlumotlari yuklanmoqda...</div>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const initData = Telegram.WebApp.initDataUnsafe;
    const user = initData.user || {};

    const defaultUser = {
      id: 123456789,
      first_name: "Do‘st",
      username: "testuser"
    };

    const currentUser = {
      id: user.id || defaultUser.id,
      first_name: user.first_name || defaultUser.first_name,
      username: user.username || user.first_name || defaultUser.username
    };

    // Xato yo‘q — id="status" to‘g‘ri
    document.getElementById('status').innerHTML = 
      `Salom, <b>${currentUser.first_name}</b>! Juft topilmoqda...`;

    const socket = io('http://localhost:3000');

    socket.emit('auth', {
      telegramId: currentUser.id,
      username: currentUser.username,
      avatarUrl: user.photo_url || `https://t.me/i/userpic/320/${currentUser.id}.jpg`,
      gender: 'other'
    });

    socket.on('auth_ok', () => {
      document.getElementById('btn').style.display = 'none';
      document.getElementById('status').innerHTML = 'Xonaga kiritildingiz...';
    });

    socket.on('room_update', (data) => {
      const count = data.players.length;
      const names = data.players.map(p => p.username).join(' va ');
      document.getElementById('status').innerHTML = 
        `<b>${count} kishi xonada:</b><br>${names}`;
    });

    socket.on('pair_started', () => {
      document.getElementById('status').innerHTML = 
        '<h2 style="font-size:40px">MATCH TOPILDI!</h2><p style="font-size:80px">❤️</p>';
    });
  </script>
</body>
</html>